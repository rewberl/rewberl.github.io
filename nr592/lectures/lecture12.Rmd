---
title: |
  | &nbsp;
  | Week 6, Lecture 12
  | Advanced statistical methods, part II: Structural equation modeling, social network analysis, and geospatial analyses
author: |
  | &nbsp;
  | Richard E.W. Berl
date: |
  | Spring 2019
  | &nbsp;
output:
  pdf_document:
    highlight: haddock
  html_document:
    highlight: haddock
    theme: flatly
---

## Social network analysis

Download Ancestral Pueblo food web network: https://www.sciencedirect.com/science/article/pii/S0305440317300377#appsec1

"Download spreadsheet (329KB)"

```{r, warning=FALSE}
library(readxl)
library(igraph)
```

```{r}
foodN = as.data.frame(read_xlsx("./data/1-s2.0-S0305440317300377-mmc1.xlsx", sheet=1))
foodE.AP = as.data.frame(read_xlsx("./data/1-s2.0-S0305440317300377-mmc1.xlsx", sheet=2,
                                   range="G2:H1398"))
```

```{r}
head(foodN)
str(foodN)

head(foodE.AP)
str(foodE.AP)
```

```{r}
foodN$Class = substr(foodN$Species, 1, 1)
foodN$Species = substr(foodN$Species, 3, nchar(foodN$Species))
```

```{r}
foodN.AP = foodN[foodN$ID %in% unique(unname(unlist(foodE.AP))),]
```

```{r}
foodE.AP = foodE.AP[,c(2,1)]
```

```{r}
foodNet = graph_from_data_frame(foodE.AP, vertices=foodN.AP)
foodNet
```

```{r, fig.width=8, fig.height=8}
plot(foodNet)
```

```{r, eval=FALSE}
?igraph::igraph.plotting
```

```{r, fig.width=8, fig.height=8}
plot(foodNet,
     vertex.size=6, vertex.shape="none",
     vertex.label.cex=ifelse(V(foodNet)$Species == "human", 1, 0.75),
     vertex.label.font=ifelse(V(foodNet)$Species == "human", 2, 1),
     vertex.label.color=as.numeric(as.factor(V(foodNet)$Class)),
     edge.arrow.size=0.5, edge.color=adjustcolor("darkgrey", alpha.f=0.15),
     layout=layout_with_kk)
```

<br>

### Descriptive statistics

**Edge density**

Ratio of the number of edges to all possible edges

```{r}
edge_density(foodNet, loops=F)
```

**Reciprocity**

Proportion of mutual connections

```{r}
reciprocity(foodNet, ignore.loops=T)
dyad_census(foodNet)
```

**Transitivity**

Probability of three vertices being connected

```{r}
transitivity(foodNet, type="global")
triad_census(foodNet)
```

```{r, eval=FALSE}
?triad_census
```

**Diameter and distance**

Longest chain of connections

```{r}
diameter(foodNet, directed=T)
get_diameter(foodNet, directed=T)
```

Bottle gourd -> human -> dog -> tick -> sage grouse -> coyote -> snowshoe hare

```{r}
mean_distance(foodNet, directed=T)
```

Shortest distance from humans to pinyon jay

```{r}
shortest_paths(foodNet, from="96", to="43", output="both")
```

Human -> dog -> tick -> centipede -> pinyon jay

<br>

#### Centrality

**Degree**

Number of connections

```{r}
degree(foodNet, v="96", mode="out")
degree(foodNet, v="96", mode="in")
```

```{r}
ego(foodNet, nodes="96", mode="out")
```

Domestic dog

```{r}
ego(foodNet, nodes="96", mode="in")
```

**Closeness**

Inverse distance to all other nodes

```{r}
closeness(foodNet, vids="96", mode="all")
closeness(foodNet, mode="all")[which.max(closeness(foodNet, mode="all"))]
```

Colorado chipmunk

**Betweenness**

Number of paths passing through a node

```{r}
betweenness(foodNet, v="96", directed=T)
betweenness(foodNet, directed=T)[which.max(betweenness(foodNet, directed=T))]
```

**Eigenvector**

Values of the first eigenvector

```{r}
eigen_centrality(foodNet, directed=T)$vector[names(eigen_centrality(foodNet, directed=T)$vector) == "96"]
eigen_centrality(foodNet, directed=T)$vector[which.max(eigen_centrality(foodNet,
                                                                        directed=T)$vector)]
```

Domestic dog

**Hub**

```{r}
hub_score(foodNet)$vector[names(hub_score(foodNet)$vector) == "96"]
hub_score(foodNet)$vector[which.max(hub_score(foodNet)$vector)]
```

Maize

**Authority**

```{r}
authority_score(foodNet)$vector[names(authority_score(foodNet)$vector) == "96"]
authority_score(foodNet)$vector[which.max(authority_score(foodNet)$vector)]
```

Mule deer

<br>

#### Community detection

```{r, eval=FALSE}
?igraph::communities
```

```{r}
foodNetU = as.undirected(foodNet, mode="mutual")
```

**By greedy optimization of modularity**

```{r}
foodNetCFG = cluster_fast_greedy(foodNetU)
foodNetCFG
dendPlot(foodNetCFG, mode="hclust")
```

**By edge betweenness**

```{r}
foodNetCB = cluster_edge_betweenness(foodNetU)
foodNetCB
dendPlot(foodNetCB, mode="hclust")
foodNetCB[20]
```

<br><br>

## Geospatial analyses

### Points

https://www.gbif.org/occurrence/search?country=ET&has_coordinate=true&has_geospatial_issue=false&taxon_key=6

"DOWNLOAD" "CSV" -> "DOWNLOAD"

Rename to .txt

```{r, eval=FALSE}
install.packages("rgbif")
```

https://ropensci.org/tutorials/rgbif_tutorial/

```{r, warning=FALSE}
library(readr)
```

```{r}
ethPlants = as.data.frame(read_tsv("./data/0009408-190415153152247.txt"))
```

```{r}
head(ethPlants)
tail(ethPlants)
str(ethPlants, give.attr=F)
```

```{r}
unique(ethPlants$class)
```

```{r}
ethPlants = ethPlants[!is.na(ethPlants$class),]
```

```{r}
library(ggplot2)
library(ggthemes)
```

```{r}
ggplot(ethPlants, aes(x=decimalLongitude, y=decimalLatitude)) +
  geom_point(aes(color=class))
```

```{r}
ggplot(ethPlants, aes(x=decimalLongitude, y=decimalLatitude)) +
  geom_point(aes(color=class), shape=16, alpha=0.25) +
  scale_color_manual(values=c(ptol_pal()(12), "#DDDDDD")) +
  guides(color=guide_legend(title=NULL)) +
  coord_cartesian() +
  theme_void()
```

<br>

### Shapefiles

https://www.naturalearthdata.com/downloads/10m-cultural-vectors/

"Admin 0 – Boundary Lines" "Download land boundaries"

"Admin 1 – States, provinces" "Download boundary lines"

```{r, eval=FALSE}
install.packages("rgdal")
```

```{r, warning=FALSE}
library(rgdal)
```

```{r}
neCountries = readOGR(dsn="./data",layer="ne_10m_admin_0_countries")
neProvinces = readOGR(dsn="./data",layer="ne_10m_admin_1_states_provinces_lines")

neCountETH = neCountries[neCountries$NAME == "Ethiopia",]
neProvETH = neProvinces[neProvinces$adm0_name == "Ethiopia",]

rm(neCountries)
rm(neProvinces)
```

```{r, eval=F}
?geom_polygon
?geom_path
```

```{r}
ggplot(ethPlants, aes(x=decimalLongitude, y=decimalLatitude)) +
  geom_path(data=neCountETH, aes(x=long, y=lat, group=group),
              color = "#000000", size=0.5, lty="solid") +
  geom_path(data=neProvETH, aes(x=long, y=lat, group=group),
            color = "#000000", size=0.5, lty="solid") +
  geom_point(aes(color=class), shape=16, alpha=0.4) +
  scale_color_manual(values=c(ptol_pal()(12), "#DDDDDD")) +
  guides(color=guide_legend(title=NULL)) +
  coord_cartesian(xlim=c(32.7, 48.3), ylim=c(2.9, 15.3)) +
  theme_void()
```

https://geonode.wfp.org/layers/ogcserver.gis.wfp.org%3Ageonode%3Aeth_trs_roads_osm

"Download Layer"

```{r}
roadsETH = readOGR(dsn="./data",layer="eth_trs_roads_osm")

roadsETH = roadsETH[roadsETH$ntlclass == "primary" |
                      roadsETH$ntlclass == "secondary" |
                      roadsETH$ntlclass == "tertiary",]
```

```{r}
ggplot(ethPlants, aes(x=decimalLongitude, y=decimalLatitude)) +
  geom_path(data=neCountETH, aes(x=long, y=lat, group=group),
              color = "#000000", size=0.5, lty="solid") +
  geom_path(data=neProvETH, aes(x=long, y=lat, group=group),
            color = "#000000", size=0.5, lty="solid") +
  geom_point(aes(color=class), shape=16, alpha=0.4) +
  geom_path(data=roadsETH, aes(x=long, y=lat, group=group),
            color = "gray", size=0.2, lty="solid") +
  scale_color_manual(values=c(ptol_pal()(12), "#DDDDDD")) +
  guides(color=guide_legend(title=NULL)) +
  coord_cartesian(xlim=c(32.7, 48.3), ylim=c(2.9, 15.3)) +
  theme_void()
```

<br>

### Rasters

https://www.naturalearthdata.com/downloads/50m-raster-data/50m-natural-earth-1/

"Natural Earth I with Shaded Relief" "Download small size"

```{r, eval=FALSE}
install.packages("raster")
```

```{r, warning=FALSE}
library(raster)
```

```{r}
ne1 = brick("./data/NE1_50M_SR.tif")

ne1ETH = crop(ne1, c(32.7, 48.3, 2.9, 15.3))
rm(ne1)

ne1ETHdf = as.data.frame(ne1ETH, xy=T)

head(ne1ETHdf)
str(ne1ETHdf)

ne1ETHdf$color=rgb(ne1ETHdf$NE1_50M_SR.1, ne1ETHdf$NE1_50M_SR.2,
                   ne1ETHdf$NE1_50M_SR.3, maxColorValue=255)
```

```{r}
# Warning: Long!
ggplot(ethPlants, aes(x=decimalLongitude, y=decimalLatitude)) +
  geom_raster(data=ne1ETHdf, aes(x=x, y=y), fill=ne1ETHdf$color) +
  geom_point(aes(color=class), shape=16, alpha=0.4) +
  scale_color_manual(values=c(ptol_pal()(12), "#DDDDDD")) +
  guides(color=guide_legend(title=NULL)) +
  coord_cartesian(xlim=c(32.7, 48.3), ylim=c(2.9, 15.3)) +
  theme_void()
```

<br>

### Point-in-polygon

```{r}
neProvShape = readOGR(dsn="./data",layer="ne_10m_admin_1_states_provinces")

neProvShapeETH = neProvShape[neProvShape$adm0_a3 == "ETH",]
```

```{r, eval=F}
?sp::over
```

```{r}
ethPlantsSP = ethPlants[!is.na(ethPlants$decimalLongitude) &
                          !is.na(ethPlants$decimalLatitude),]
coordinates(ethPlantsSP) = ~ decimalLongitude + decimalLatitude
proj4string(ethPlantsSP) = CRS(proj4string(neProvShapeETH))
```

```{r}
ethPlantsInGambela = over(ethPlantsSP,
                          neProvShapeETH[neProvShapeETH$name == "Gambela Peoples",])
ethPlantsInGambela = ethPlants[!is.na(ethPlantsInGambela$name),]
head(ethPlantsInGambela$class, 20)
```

```{r}
ggplot(ethPlantsInGambela, aes(x=decimalLongitude, y=decimalLatitude)) +
  geom_path(data=neCountETH, aes(x=long, y=lat, group=group),
              color = "#000000", size=0.5, lty="solid") +
  geom_path(data=neProvETH, aes(x=long, y=lat, group=group),
            color = "#000000", size=0.5, lty="solid") +
  geom_point(aes(color=class), shape=16, alpha=0.4) +
  scale_color_manual(values=c(ptol_pal()(12), "#DDDDDD")) +
  guides(color=guide_legend(title=NULL)) +
  coord_cartesian(xlim=c(32.7, 48.3), ylim=c(2.9, 15.3)) +
  theme_void()
```

<br>

### Geocoding

```{r, eval=FALSE}
install.packages("ggmap")
```

```{r, eval=F}
?ggmap::geocode
```

<br>

### Distance matrix

```{r, eval=FALSE}
install.packages("geodist")
```

```{r, eval=FALSE}
?geodist::geodist
```


<br><br>


([pdf](./lecture12.pdf) / [Rmd](./lecture12.Rmd))

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>